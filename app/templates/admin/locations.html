{% extends "base.html" %}

{% block title %}Manage Locations - Tuesday Lunch Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Manage Locations</h1>
            <p class="text-gray-600">{{ locations|length }} locations in database</p>
        </div>
        <a href="{{ url_for('admin.dashboard') }}" class="text-blue-600 hover:underline">
            ‚Üê Back to Dashboard
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Add Location Section -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Add New Location</h2>

        <!-- Search with Google Places -->
        <div class="space-y-4">
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search for a Restaurant</label>
                <input type="text" id="place_search"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Start typing restaurant name..."
                       autocomplete="off">

                <!-- Autocomplete Results -->
                <div id="autocomplete_results"
                     class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-64 overflow-y-auto">
                </div>

                <!-- Loading indicator -->
                <div id="search_loading" class="hidden absolute right-3 top-9">
                    <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>

            <!-- Selected Place Preview -->
            <div id="selected_place" class="hidden">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium text-blue-900" id="selected_name"></div>
                            <div class="text-sm text-blue-700" id="selected_address"></div>
                            <div class="text-sm text-blue-600" id="selected_phone"></div>
                            <div class="flex flex-wrap gap-2 mt-2 text-xs">
                                <span id="selected_rating" class="hidden bg-yellow-100 text-yellow-800 px-2 py-1 rounded"></span>
                                <span id="selected_price" class="hidden bg-green-100 text-green-800 px-2 py-1 rounded"></span>
                                <span id="selected_cuisine" class="hidden bg-purple-100 text-purple-800 px-2 py-1 rounded"></span>
                            </div>
                        </div>
                        <button type="button" onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 p-1 ml-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Add Location Form (shown after selection) -->
                <form action="{{ url_for('admin.add_location') }}" method="POST" class="mt-4 space-y-4">
                    <input type="hidden" name="name" id="form_name">
                    <input type="hidden" name="address" id="form_address">
                    <input type="hidden" name="phone" id="form_phone">
                    <input type="hidden" name="google_place_id" id="form_place_id">
                    <input type="hidden" name="google_rating" id="form_rating">
                    <input type="hidden" name="price_level" id="form_price">
                    <input type="hidden" name="cuisine_type" id="form_cuisine">

                    <div class="flex items-center">
                        <input type="checkbox" name="group_friendly" id="group_friendly" checked
                               class="h-5 w-5 text-blue-600 rounded">
                        <label for="group_friendly" class="ml-3 text-sm text-gray-700">
                            Group friendly (can accommodate 15-20 people)
                        </label>
                    </div>

                    <button type="submit"
                            class="w-full sm:w-auto bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Add Location
                    </button>
                </form>
            </div>

            <!-- Manual Entry Toggle -->
            <div class="pt-2">
                <button type="button" onclick="toggleManualEntry()" id="toggle_manual"
                        class="text-sm text-blue-600 hover:text-blue-800 underline">
                    Can't find it? Enter manually
                </button>
            </div>

            <!-- Manual Entry Form -->
            <div id="manual_entry" class="hidden space-y-4 pt-4 border-t border-gray-200">
                <form action="{{ url_for('admin.add_location') }}" method="POST" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Restaurant Name *</label>
                        <input type="text" name="name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., Monticello Hotel">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input type="text" name="address"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="123 Main St, Longview, WA">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="tel" name="phone"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="(360) 555-1234">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cuisine Type</label>
                            <input type="text" name="cuisine_type"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., American">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price Level (1-4)</label>
                            <select name="price_level"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Unknown</option>
                                <option value="1">$ - Inexpensive</option>
                                <option value="2">$$ - Moderate</option>
                                <option value="3">$$$ - Expensive</option>
                                <option value="4">$$$$ - Very Expensive</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="group_friendly" id="manual_group_friendly" checked
                               class="h-5 w-5 text-blue-600 rounded">
                        <label for="manual_group_friendly" class="ml-3 text-sm text-gray-700">
                            Group friendly (can accommodate 15-20 people)
                        </label>
                    </div>
                    <button type="submit"
                            class="w-full sm:w-auto bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Add Location Manually
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Existing Locations -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">All Locations</h2>
        </div>

        {% if locations %}
            <div class="divide-y divide-gray-200">
                {% for location in locations %}
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">{{ location.name }}</div>
                                {% if location.address %}
                                    <div class="text-sm text-gray-500">{{ location.address }}</div>
                                {% endif %}
                                <div class="flex flex-wrap gap-2 mt-2 text-xs">
                                    {% if location.google_rating %}
                                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                            Google: {{ location.google_rating }}/5
                                        </span>
                                    {% endif %}
                                    {% if location.avg_group_rating %}
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                            Group: {{ "%.1f"|format(location.avg_group_rating) }}/5
                                        </span>
                                    {% endif %}
                                    {% if location.price_level %}
                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded">
                                            {{ '$' * location.price_level }}
                                        </span>
                                    {% endif %}
                                    {% if location.cuisine_type %}
                                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                            {{ location.cuisine_type }}
                                        </span>
                                    {% endif %}
                                    {% if location.visit_count %}
                                        <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">
                                            {{ location.visit_count }} visit{{ 's' if location.visit_count != 1 else '' }}
                                        </span>
                                    {% endif %}
                                    {% if location.last_visited %}
                                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                            Last: {{ location.last_visited.strftime('%b %d, %Y') }}
                                        </span>
                                    {% endif %}
                                    {% if not location.group_friendly %}
                                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded">
                                            Not group-friendly
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <a href="{{ url_for('admin.edit_location', location_id=location.id) }}"
                                   class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                    Edit
                                </a>
                                <form action="{{ url_for('admin.delete_location', location_id=location.id) }}"
                                      method="POST"
                                      onsubmit="return confirm('Delete {{ location.name }}? This cannot be undone.');">
                                    <button type="submit"
                                            class="px-3 py-2 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="p-6 text-center text-gray-500">
                No locations yet. Add one above!
            </div>
        {% endif %}
    </div>
</div>

<script>
// Debounce function
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Search places with debouncing
const searchPlaces = debounce(async function(query) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const loadingDiv = document.getElementById('search_loading');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    loadingDiv.classList.remove('hidden');

    try {
        const response = await fetch(`/api/places/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        loadingDiv.classList.add('hidden');

        if (data.success && data.places.length > 0) {
            resultsDiv.innerHTML = data.places.map(place => `
                <button type="button"
                        class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-b-0"
                        onclick="selectPlace('${place.place_id}', '${escapeHtml(place.name)}', '${escapeHtml(place.address || '')}')">
                    <div class="font-medium text-gray-900">${escapeHtml(place.name)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(place.address || '')}</div>
                </button>
            `).join('');
            resultsDiv.classList.remove('hidden');
        } else if (data.success && data.places.length === 0) {
            resultsDiv.innerHTML = `
                <div class="px-4 py-3 text-gray-500 text-sm">
                    No restaurants found. Try a different search or enter manually.
                </div>
            `;
            resultsDiv.classList.remove('hidden');
        } else {
            resultsDiv.classList.add('hidden');
        }
    } catch (error) {
        loadingDiv.classList.add('hidden');
        console.error('Search error:', error);
    }
}, 300);

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle search input
document.getElementById('place_search').addEventListener('input', function(e) {
    searchPlaces(e.target.value);
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const searchInput = document.getElementById('place_search');
    if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
        resultsDiv.classList.add('hidden');
    }
});

// Select a place from autocomplete
async function selectPlace(placeId, name, address) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const selectedDiv = document.getElementById('selected_place');
    const searchInput = document.getElementById('place_search');

    resultsDiv.classList.add('hidden');
    searchInput.value = name;

    // Fetch full place details
    try {
        const response = await fetch(`/api/places/${placeId}`);
        const data = await response.json();

        if (data.success && data.place) {
            const place = data.place;

            // Update form hidden fields
            document.getElementById('form_name').value = place.name;
            document.getElementById('form_address').value = place.address || '';
            document.getElementById('form_phone').value = place.phone || '';
            document.getElementById('form_place_id').value = place.place_id || '';
            document.getElementById('form_rating').value = place.google_rating || '';
            document.getElementById('form_price').value = place.price_level || '';
            document.getElementById('form_cuisine').value = place.cuisine_type || '';

            // Update preview
            document.getElementById('selected_name').textContent = place.name;
            document.getElementById('selected_address').textContent = place.address || 'Address not available';
            document.getElementById('selected_phone').textContent = place.phone || '';

            // Rating
            const ratingSpan = document.getElementById('selected_rating');
            if (place.google_rating) {
                ratingSpan.textContent = `Google: ${place.google_rating}/5`;
                ratingSpan.classList.remove('hidden');
            } else {
                ratingSpan.classList.add('hidden');
            }

            // Price
            const priceSpan = document.getElementById('selected_price');
            if (place.price_level) {
                priceSpan.textContent = '$'.repeat(place.price_level);
                priceSpan.classList.remove('hidden');
            } else {
                priceSpan.classList.add('hidden');
            }

            // Cuisine
            const cuisineSpan = document.getElementById('selected_cuisine');
            if (place.cuisine_type) {
                cuisineSpan.textContent = place.cuisine_type;
                cuisineSpan.classList.remove('hidden');
            } else {
                cuisineSpan.classList.add('hidden');
            }

            selectedDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error fetching place details:', error);
        // Fall back to basic info
        document.getElementById('form_name').value = name;
        document.getElementById('form_address').value = address;
        document.getElementById('selected_name').textContent = name;
        document.getElementById('selected_address').textContent = address || 'Address not available';
        selectedDiv.classList.remove('hidden');
    }
}

// Clear selection
function clearSelection() {
    document.getElementById('selected_place').classList.add('hidden');
    document.getElementById('place_search').value = '';
    document.getElementById('form_name').value = '';
    document.getElementById('form_address').value = '';
    document.getElementById('form_phone').value = '';
    document.getElementById('form_place_id').value = '';
    document.getElementById('form_rating').value = '';
    document.getElementById('form_price').value = '';
    document.getElementById('form_cuisine').value = '';
}

// Toggle manual entry section
function toggleManualEntry() {
    const manualDiv = document.getElementById('manual_entry');
    const toggleBtn = document.getElementById('toggle_manual');

    if (manualDiv.classList.contains('hidden')) {
        manualDiv.classList.remove('hidden');
        toggleBtn.textContent = 'Use search instead';
    } else {
        manualDiv.classList.add('hidden');
        toggleBtn.textContent = "Can't find it? Enter manually";
    }
}
</script>
{% endblock %}

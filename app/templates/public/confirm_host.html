{% extends "base.html" %}

{% block title %}Select Restaurant - Tuesday Lunch{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto space-y-6">
    <!-- Header -->
    <div class="text-center">
        <h1 class="text-2xl font-bold text-gray-900">You're Hosting!</h1>
        <p class="text-gray-600 mt-2">
            Tuesday, {{ lunch.date.strftime('%B %d, %Y') }}
        </p>
        {% if host %}
            <p class="text-sm text-gray-500 mt-1">Hi {{ host.name }}!</p>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Info Box -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
        <p class="text-blue-800 text-sm">
            Please select a restaurant for this week's lunch. The secretary will make a reservation once you confirm.
        </p>
    </div>

    <form action="{{ url_for('main.submit_confirmation', token=token) }}" method="POST" class="space-y-6">
        <!-- Previous Locations -->
        {% if recent_locations %}
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-semibold text-gray-900 mb-4">Previous Locations</h2>
                <div class="space-y-3">
                    {% for location in recent_locations %}
                        <label class="block p-4 border-2 rounded-lg cursor-pointer hover:border-blue-500 transition-colors
                                      {% if loop.first %}border-blue-500 bg-blue-50{% else %}border-gray-200{% endif %}">
                            <div class="flex items-start">
                                <input type="radio" name="location_id" value="{{ location.id }}"
                                       class="mt-1 h-5 w-5 text-blue-600"
                                       {% if loop.first %}checked{% endif %}
                                       onchange="selectExisting()">
                                <div class="ml-3 flex-1">
                                    <div class="font-medium text-gray-900">{{ location.name }}</div>
                                    {% if location.address %}
                                        <div class="text-sm text-gray-500">{{ location.address }}</div>
                                    {% endif %}
                                    <div class="flex flex-wrap gap-2 mt-2 text-xs">
                                        {% if location.avg_group_rating %}
                                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                                Group: {{ "%.1f"|format(location.avg_group_rating) }}/5
                                            </span>
                                        {% endif %}
                                        {% if location.google_rating %}
                                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">
                                                Google: {{ location.google_rating }}/5
                                            </span>
                                        {% endif %}
                                        {% if location.price_level %}
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">
                                                {{ '$' * location.price_level }}
                                            </span>
                                        {% endif %}
                                        {% if location.last_visited %}
                                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                                Last: {{ location.last_visited.strftime('%b %d') }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- New Location with Google Places Autocomplete -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-gray-900 mb-4">Suggest a New Place</h2>
            <div class="space-y-4">
                <!-- Search Input with Autocomplete -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search for a Restaurant</label>
                    <input type="text" id="place_search"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Start typing restaurant name..."
                           autocomplete="off"
                           onfocus="selectNew()">

                    <!-- Autocomplete Results -->
                    <div id="autocomplete_results"
                         class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-64 overflow-y-auto">
                    </div>

                    <!-- Loading indicator -->
                    <div id="search_loading" class="hidden absolute right-3 top-9">
                        <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Selected Place Preview (populated when user selects from autocomplete) -->
                <div id="selected_place" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-green-900" id="selected_name"></div>
                            <div class="text-sm text-green-700" id="selected_address"></div>
                            <div class="flex flex-wrap gap-2 mt-2 text-xs">
                                <span id="selected_rating" class="hidden bg-yellow-100 text-yellow-800 px-2 py-1 rounded"></span>
                                <span id="selected_price" class="hidden bg-green-100 text-green-800 px-2 py-1 rounded"></span>
                                <span id="selected_cuisine" class="hidden bg-blue-100 text-blue-800 px-2 py-1 rounded"></span>
                            </div>
                        </div>
                        <button type="button" onclick="clearSelection()" class="text-green-600 hover:text-green-800 p-1">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Hidden Fields for Selected Place -->
                <input type="hidden" name="new_location_name" id="new_location_name">
                <input type="hidden" name="new_location_address" id="new_location_address">
                <input type="hidden" name="new_location_phone" id="new_location_phone">
                <input type="hidden" name="google_place_id" id="google_place_id">
                <input type="hidden" name="google_rating" id="google_rating">
                <input type="hidden" name="price_level" id="price_level">
                <input type="hidden" name="cuisine_type" id="cuisine_type">

                <!-- Manual Entry Fallback -->
                <div id="manual_entry" class="hidden space-y-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-gray-600">Or enter details manually:</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Restaurant Name</label>
                        <input type="text" id="manual_name"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., Monticello Hotel"
                               oninput="syncManualName()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address (optional)</label>
                        <input type="text" id="manual_address"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="123 Main St, Longview, WA"
                               oninput="syncManualAddress()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                        <input type="tel" id="manual_phone"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="(360) 555-1234"
                               oninput="syncManualPhone()">
                    </div>
                </div>

                <!-- Toggle Manual Entry -->
                <button type="button" id="toggle_manual" onclick="toggleManualEntry()"
                        class="text-sm text-blue-600 hover:text-blue-800 underline">
                    Can't find it? Enter manually
                </button>

                <!-- Group Friendly Confirmation -->
                <div class="flex items-start pt-2">
                    <input type="checkbox" name="group_friendly" id="group_friendly"
                           class="mt-1 h-5 w-5 text-blue-600 rounded">
                    <label for="group_friendly" class="ml-3 text-sm text-gray-700">
                        I confirm this restaurant can accommodate our group (15-20 people)
                    </label>
                </div>
            </div>
        </div>

        <!-- Hidden field to track selection type -->
        <input type="hidden" name="selection_type" id="selection_type" value="{% if recent_locations %}existing{% else %}new{% endif %}">

        <!-- Submit Button -->
        <button type="submit"
                class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors shadow-lg">
            Confirm Restaurant
        </button>
    </form>

    <p class="text-center text-sm text-gray-500">
        Please respond by Friday morning so we have time to make a reservation.
    </p>
</div>

<script>
// Debounce function
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Search places with debouncing
const searchPlaces = debounce(async function(query) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const loadingDiv = document.getElementById('search_loading');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    loadingDiv.classList.remove('hidden');

    try {
        const response = await fetch(`/api/places/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        loadingDiv.classList.add('hidden');

        if (data.success && data.places.length > 0) {
            resultsDiv.innerHTML = data.places.map(place => `
                <button type="button"
                        class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-b-0"
                        onclick="selectPlace('${place.place_id}', '${escapeHtml(place.name)}', '${escapeHtml(place.address || '')}')">
                    <div class="font-medium text-gray-900">${escapeHtml(place.name)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(place.address || '')}</div>
                </button>
            `).join('');
            resultsDiv.classList.remove('hidden');
        } else if (data.success && data.places.length === 0) {
            resultsDiv.innerHTML = `
                <div class="px-4 py-3 text-gray-500 text-sm">
                    No restaurants found. Try a different search or enter manually.
                </div>
            `;
            resultsDiv.classList.remove('hidden');
        } else {
            resultsDiv.classList.add('hidden');
        }
    } catch (error) {
        loadingDiv.classList.add('hidden');
        console.error('Search error:', error);
    }
}, 300);

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle search input
document.getElementById('place_search').addEventListener('input', function(e) {
    searchPlaces(e.target.value);
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const searchInput = document.getElementById('place_search');
    if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
        resultsDiv.classList.add('hidden');
    }
});

// Select a place from autocomplete
async function selectPlace(placeId, name, address) {
    const resultsDiv = document.getElementById('autocomplete_results');
    const selectedDiv = document.getElementById('selected_place');
    const searchInput = document.getElementById('place_search');

    resultsDiv.classList.add('hidden');
    searchInput.value = name;

    // Fetch full place details
    try {
        const response = await fetch(`/api/places/${placeId}`);
        const data = await response.json();

        if (data.success && data.place) {
            const place = data.place;

            // Update hidden fields
            document.getElementById('new_location_name').value = place.name;
            document.getElementById('new_location_address').value = place.address || '';
            document.getElementById('new_location_phone').value = place.phone || '';
            document.getElementById('google_place_id').value = place.place_id || '';
            document.getElementById('google_rating').value = place.google_rating || '';
            document.getElementById('price_level').value = place.price_level || '';
            document.getElementById('cuisine_type').value = place.cuisine_type || '';

            // Update preview
            document.getElementById('selected_name').textContent = place.name;
            document.getElementById('selected_address').textContent = place.address || 'Address not available';

            // Rating
            const ratingSpan = document.getElementById('selected_rating');
            if (place.google_rating) {
                ratingSpan.textContent = `Google: ${place.google_rating}/5`;
                ratingSpan.classList.remove('hidden');
            } else {
                ratingSpan.classList.add('hidden');
            }

            // Price
            const priceSpan = document.getElementById('selected_price');
            if (place.price_level) {
                priceSpan.textContent = '$'.repeat(place.price_level);
                priceSpan.classList.remove('hidden');
            } else {
                priceSpan.classList.add('hidden');
            }

            // Cuisine
            const cuisineSpan = document.getElementById('selected_cuisine');
            if (place.cuisine_type) {
                cuisineSpan.textContent = place.cuisine_type;
                cuisineSpan.classList.remove('hidden');
            } else {
                cuisineSpan.classList.add('hidden');
            }

            selectedDiv.classList.remove('hidden');
            document.getElementById('selection_type').value = 'new';

            // Uncheck existing location radios
            document.querySelectorAll('input[name=location_id]').forEach(r => r.checked = false);
        }
    } catch (error) {
        console.error('Error fetching place details:', error);
        // Fall back to basic info
        document.getElementById('new_location_name').value = name;
        document.getElementById('new_location_address').value = address;
        document.getElementById('selected_name').textContent = name;
        document.getElementById('selected_address').textContent = address || 'Address not available';
        selectedDiv.classList.remove('hidden');
    }
}

// Clear selection
function clearSelection() {
    document.getElementById('selected_place').classList.add('hidden');
    document.getElementById('place_search').value = '';
    document.getElementById('new_location_name').value = '';
    document.getElementById('new_location_address').value = '';
    document.getElementById('new_location_phone').value = '';
    document.getElementById('google_place_id').value = '';
    document.getElementById('google_rating').value = '';
    document.getElementById('price_level').value = '';
    document.getElementById('cuisine_type').value = '';

    // Re-select first existing location if available
    const firstRadio = document.querySelector('input[name=location_id]');
    if (firstRadio) {
        firstRadio.checked = true;
        document.getElementById('selection_type').value = 'existing';
    }
}

// Toggle manual entry section
function toggleManualEntry() {
    const manualDiv = document.getElementById('manual_entry');
    const toggleBtn = document.getElementById('toggle_manual');

    if (manualDiv.classList.contains('hidden')) {
        manualDiv.classList.remove('hidden');
        toggleBtn.textContent = 'Use search instead';
    } else {
        manualDiv.classList.add('hidden');
        toggleBtn.textContent = "Can't find it? Enter manually";
    }
}

// Sync manual entry fields to hidden fields
function syncManualName() {
    document.getElementById('new_location_name').value = document.getElementById('manual_name').value;
    document.getElementById('selection_type').value = 'new';
}

function syncManualAddress() {
    document.getElementById('new_location_address').value = document.getElementById('manual_address').value;
}

function syncManualPhone() {
    document.getElementById('new_location_phone').value = document.getElementById('manual_phone').value;
}

// Selection type helpers
function selectExisting() {
    document.getElementById('selection_type').value = 'existing';
    clearSelection();
}

function selectNew() {
    document.getElementById('selection_type').value = 'new';
    document.querySelectorAll('input[name=location_id]').forEach(r => r.checked = false);
}
</script>
{% endblock %}
